<mxfile host="app.diagrams.net" modified="2026-02-09T00:00:00.000Z" agent="Claude" version="24.0.0">
  <diagram name="Terminal Sync Flow" id="terminal-sync">
    <mxGraphModel dx="1434" dy="844" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1200" pageHeight="900" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="Terminal API Sync - Data Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="300" y="30" width="600" height="50" as="geometry" />
        </mxCell>

        <!-- Step 1: BullMQ Trigger -->
        <mxCell id="step1-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#388E3C;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="450" y="120" width="300" height="80" as="geometry" />
        </mxCell>
        <mxCell id="step1-icon" value="â°" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=40;" vertex="1" parent="1">
          <mxGeometry x="460" y="130" width="60" height="60" as="geometry" />
        </mxCell>
        <mxCell id="step1-title" value="STEP 1: Scheduled Job Trigger" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#388E3C;" vertex="1" parent="1">
          <mxGeometry x="530" y="130" width="210" height="25" as="geometry" />
        </mxCell>
        <mxCell id="step1-desc" value="BullMQ triggers job every 5 minutes&#xa;for each configured terminal" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="530" y="160" width="210" height="35" as="geometry" />
        </mxCell>

        <!-- Arrow 1 -->
        <mxCell id="arrow1" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#388E3C;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="600" y="200" as="sourcePoint" />
            <mxPoint x="600" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Step 2: Call API -->
        <mxCell id="step2-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FF;strokeColor=#0288D1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="450" y="250" width="300" height="80" as="geometry" />
        </mxCell>
        <mxCell id="step2-icon" value="ðŸŒ" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=40;" vertex="1" parent="1">
          <mxGeometry x="460" y="260" width="60" height="60" as="geometry" />
        </mxCell>
        <mxCell id="step2-title" value="STEP 2: Call Terminal API" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#0288D1;" vertex="1" parent="1">
          <mxGeometry x="530" y="260" width="210" height="25" as="geometry" />
        </mxCell>
        <mxCell id="step2-desc" value="HTTP GET to terminal endpoint&#xa;e.g., /api/v1/containers" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="530" y="290" width="210" height="35" as="geometry" />
        </mxCell>

        <!-- Decision: Success? -->
        <mxCell id="arrow2" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#0288D1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="600" y="330" as="sourcePoint" />
            <mxPoint x="600" y="380" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="decision-box" value="" style="rhombus;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#F57C00;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="520" y="380" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="decision-text" value="API&#xa;Success?" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=16;fontStyle=1;fontColor=#F57C00;" vertex="1" parent="1">
          <mxGeometry x="550" y="420" width="100" height="40" as="geometry" />
        </mxCell>

        <!-- NO Path: Retry -->
        <mxCell id="arrow-no" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#D32F2F;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="decision-box">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="550" as="sourcePoint" />
            <mxPoint x="300" y="440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="no-label" value="NO" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontStyle=1;fontColor=#D32F2F;" vertex="1" connectable="0" parent="arrow-no">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="20" y="-8" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="retry-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#D32F2F;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="80" y="400" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="retry-icon" value="ðŸ”„" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=30;" vertex="1" parent="1">
          <mxGeometry x="90" y="410" width="50" height="60" as="geometry" />
        </mxCell>
        <mxCell id="retry-title" value="Retry Logic" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#D32F2F;" vertex="1" parent="1">
          <mxGeometry x="150" y="410" width="140" height="25" as="geometry" />
        </mxCell>
        <mxCell id="retry-desc" value="â€¢ Schedule retry (1 min)&#xa;â€¢ Log failure to DB" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="150" y="435" width="140" height="40" as="geometry" />
        </mxCell>

        <!-- YES Path: Continue -->
        <mxCell id="arrow-yes" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#388E3C;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="decision-box">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="600" as="sourcePoint" />
            <mxPoint x="600" y="550" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="yes-label" value="YES" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=14;fontStyle=1;fontColor=#388E3C;" vertex="1" connectable="0" parent="arrow-yes">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="20" y="-5" as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Step 3: Parse Response -->
        <mxCell id="step3-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#7B1FA2;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="450" y="550" width="300" height="80" as="geometry" />
        </mxCell>
        <mxCell id="step3-icon" value="ðŸ“‹" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=40;" vertex="1" parent="1">
          <mxGeometry x="460" y="560" width="60" height="60" as="geometry" />
        </mxCell>
        <mxCell id="step3-title" value="STEP 3: Parse JSON Response" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#7B1FA2;" vertex="1" parent="1">
          <mxGeometry x="530" y="560" width="210" height="25" as="geometry" />
        </mxCell>
        <mxCell id="step3-desc" value="Extract container data&#xa;Validate with Zod schema" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="530" y="590" width="210" height="35" as="geometry" />
        </mxCell>

        <!-- Arrow 3 -->
        <mxCell id="arrow3" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#7B1FA2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="600" y="630" as="sourcePoint" />
            <mxPoint x="600" y="680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Step 4: Update Database -->
        <mxCell id="step4-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#388E3C;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="450" y="680" width="300" height="100" as="geometry" />
        </mxCell>
        <mxCell id="step4-icon" value="ðŸ’¾" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=40;" vertex="1" parent="1">
          <mxGeometry x="460" y="690" width="60" height="80" as="geometry" />
        </mxCell>
        <mxCell id="step4-title" value="STEP 4: Update PostgreSQL" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#388E3C;" vertex="1" parent="1">
          <mxGeometry x="530" y="690" width="210" height="25" as="geometry" />
        </mxCell>
        <mxCell id="step4-desc" value="â€¢ Upsert containers in DB&#xa;â€¢ Update availability status&#xa;â€¢ Track which changed" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="530" y="720" width="210" height="50" as="geometry" />
        </mxCell>

        <!-- Split to two parallel steps -->
        <mxCell id="arrow4a" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#388E3C;exitX=0.3;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="step4-box">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="850" as="sourcePoint" />
            <mxPoint x="340" y="830" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="arrow4b" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#388E3C;exitX=0.7;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="step4-box">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="850" as="sourcePoint" />
            <mxPoint x="860" y="830" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Step 5a: Update Redis -->
        <mxCell id="step5a-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FCE4EC;strokeColor=#C2185B;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="80" y="830" width="260" height="80" as="geometry" />
        </mxCell>
        <mxCell id="step5a-icon" value="âš¡" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=35;" vertex="1" parent="1">
          <mxGeometry x="90" y="840" width="50" height="60" as="geometry" />
        </mxCell>
        <mxCell id="step5a-title" value="STEP 5a: Update Redis Cache" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#C2185B;" vertex="1" parent="1">
          <mxGeometry x="150" y="840" width="180" height="25" as="geometry" />
        </mxCell>
        <mxCell id="step5a-desc" value="Store container data in Redis&#xa;TTL: 5 minutes" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="150" y="870" width="180" height="35" as="geometry" />
        </mxCell>

        <!-- Step 5b: Log Success -->
        <mxCell id="step5b-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="860" y="830" width="260" height="80" as="geometry" />
        </mxCell>
        <mxCell id="step5b-icon" value="ðŸ“" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=35;" vertex="1" parent="1">
          <mxGeometry x="870" y="840" width="50" height="60" as="geometry" />
        </mxCell>
        <mxCell id="step5b-title" value="STEP 5b: Log Sync Success" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#F57F17;" vertex="1" parent="1">
          <mxGeometry x="930" y="840" width="180" height="25" as="geometry" />
        </mxCell>
        <mxCell id="step5b-desc" value="Record to api_sync_logs:&#xa;â€¢ Terminal ID, timestamp, count" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="930" y="870" width="180" height="35" as="geometry" />
        </mxCell>

        <!-- Code Example Box -->
        <mxCell id="code-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FAFAFA;strokeColor=#9E9E9E;strokeWidth=1;align=left;verticalAlign=top;fontFamily=Courier New;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="820" y="120" width="350" height="350" as="geometry" />
        </mxCell>
        <mxCell id="code-title" value="Sample Code (Worker)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#424242;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="830" y="130" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="code-text" value="const worker = new Worker(&#xa;  'terminal-sync',&#xa;  async (job) => {&#xa;    const { terminalId } = job.data;&#xa;    &#xa;    // Step 2: Call API&#xa;    const res = await fetch(&#xa;      terminal.api_endpoint&#xa;    );&#xa;    &#xa;    if (!res.ok) {&#xa;      // Retry automatically&#xa;      throw new Error('API failed');&#xa;    }&#xa;    &#xa;    // Step 3: Parse&#xa;    const data = await res.json();&#xa;    &#xa;    // Step 4: Update DB&#xa;    await prisma.container&#xa;      .updateMany({...});&#xa;    &#xa;    // Step 5a: Cache&#xa;    await redis.setex(&#xa;      `containers:${terminalId}`,&#xa;      300,&#xa;      JSON.stringify(data)&#xa;    );&#xa;    &#xa;    // Step 5b: Log&#xa;    await prisma.apiSyncLog&#xa;      .create({...});&#xa;  }&#xa;);" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=9;fontColor=#424242;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="830" y="160" width="330" height="300" as="geometry" />
        </mxCell>

        <!-- Timeline indicator -->
        <mxCell id="timeline" value="â±ï¸ Total time: 1-3 seconds per terminal" style="text;html=1;strokeColor=none;fillColor=#E3F2FD;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1;fontColor=#0288D1;" vertex="1" parent="1">
          <mxGeometry x="820" y="520" width="350" height="40" as="geometry" />
        </mxCell>

        <!-- Benefits box -->
        <mxCell id="benefits-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#388E3C;strokeWidth=2;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="820" y="600" width="350" height="150" as="geometry" />
        </mxCell>
        <mxCell id="benefits-title" value="âœ… Benefits of This Approach" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=14;fontStyle=1;fontColor=#388E3C;" vertex="1" parent="1">
          <mxGeometry x="830" y="610" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="benefits-text" value="â€¢ Automatic retries if terminal API fails&#xa;â€¢ Background processing (doesn't block users)&#xa;â€¢ Job monitoring and logging&#xa;â€¢ Scalable: add more workers as needed&#xa;â€¢ Fast lookups via Redis cache&#xa;â€¢ Audit trail in database" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="840" y="640" width="320" height="100" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
